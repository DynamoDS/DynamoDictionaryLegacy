<!DOCTYPE html>
<meta charset="utf-8">
<head>
<link href='https://fonts.googleapis.com/css?family=Raleway:400,200,500,300,700,900,800' rel='stylesheet' type='text/css'>
<style>

    
    body {
        margin: 0;
/*        background: #ffffff;*/
        padding: 0;
        /*        text-align: center;*/
        /*        text-transform: uppercase;*/
        font-family: 'Raleway', sans-serif;
        /*        background: #d3d3d3;*/
    }
    
    html {
        overflow-y: scroll;
    }
    

    
    .dummyHeader {
        margin-left: 8%;
        width: 84%;
    }
    /*
    #catSoftware{
        color:"red";
    }
*/
    .secondTitle{
        font-family: 'Raleway', sans-serif;
        font-weight:200;
        font-size: 28px;
        opacity: 1;
        text-transform: uppercase;
        color:white;
        line-height: 50%;
    }
    .svgDiv {
        text-align: center;
        width: 100%;
        margin: 0 auto;
        width: 84%;
        margin-left: 8%;
        /*        overflow-y: scroll; */
    }
    
    .legendText {
/*        position: absolute;*/
    }
    /*
    e{
        color:"red";
    }
*/
    a {
    text-decoration: none;
}

    .header {
        text-align: left;
        /*        margin-left: 25%;*/
        height: 105px;
        /*        height: 120px;*/
        background: #333333;
        /*                background:#000000;*/
        opacity: 1;
        /*        border:1px solid #CCC;*/
        position: fixed;
        /*        margin-left: 37.5%;*/
        width: 100%;
        margin-left: 0%;
        font-family: 'Raleway', sans-serif;
        font-weight:200;
        /*        border-style: solid;*/
        /*    border-bottom: 1px dotted #000000;*/
    }
    
    .svgContainer {
        margin-top: 120px;
        margin-left: 0%;
        /*        margin-left:0%;*/
        /*        width:50%;        */
    }
    
    .svgContainerFixed {
        margin: 0 auto;
/*        background: #FFFFFF;*/
        /*                background:#000000;*/
        opacity: 1;
        margin-top: 145px;
        position: fixed;
        /*        width:50%;*/
        /*        width:50%;        */
    }
    
    .blurbTitle {
        /*         text-align: left;*/
        /*    position: relative;*/
        font-size: 28px;
        opacity: 1;
        color:white;
font-family: 'Raleway', sans-serif;
        font-weight:500;
        text-transform: uppercase;
        line-height: 50%;
/*        margin-left:15%;*/
        /*    top: 30%;*/
        /*  transform: translateY(-50%);*/
    }
    
    .blurb {
        /*         text-align: left;*/
        /*    position: relative;*/
        font-size: 14px;
        opacity: 1;
        color:white;
        font-family: 'Raleway', sans-serif; 
        font-weight:200;
/*        text-transform: uppercase;*/
        /*    top: 50%;*/
        /*  transform: translateY(-50%);*/
    }
    
    .catsort {
                 text-align: right;
        margin-right:8.5%;
        /*    position: relative;*/
        font-size: 12px;
        opacity: 1;
        font-family: 'Raleway', sans-serif;
        /*    top: 50%;*/
        /*  transform: translateY(-50%);*/
    }
    
    .colSet {
        text-align: right;
        /*         text-align: left;*/
        /*    position: relative;*/
        font-size: 12px;
        opacity: 1;
        font-family: 'Raleway', sans-serif;
        /*        text-align:'center';*/
        /*    top: 50%;*/
        /*  transform: translateY(-50%);*/
    }
    
    .sb {
        text-align: right;
        margin-right:8.5%;
        /*         text-align: left;*/
        /*    position: relative;*/
        font-size: 12px;
        opacity: 1;
        font-family: 'Raleway', sans-serif;
        /*        text-align:'center';*/
        /*    top: 50%;*/
        /*  transform: translateY(-50%);*/
    }
    /*
    .header-html {
    position: absolute;
    bottom: 0;
    left: 0;
  }
*/
    
    .blockLink {
        /*        target:"_top";*/
    }
    
    body {
        font: 10px sans-serif;
    }
    
    
    #btnSearch {
        text-align: right;
        display: none;
    }
    
    .bText {
        text-align: center;
    }
</style>

    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Mode Lab | Experiments</title>



</head>

<body>

    <!--    <form onsubmit="handleClick()">-->

    <!--    <input type="submit" id="btnSearch" onclick="handleClick();">-->
    <!--</form>-->

    <!--    <form name="myform" onSubmit="return handleClick()">-->
    <!--            <input name="Submit"  type="submit" value="Add to list" >-->
    <!--            <input type="text" id="searchBox" onfocus="handleClick()" placeholder="search and press enter...">-->
    <!--        </form>-->
    <div class="header"></div>
    <div class="svgDiv"></div>
    <div class="dummyHeader"></div>




    <script src="js/d3.min.js"></script>
    <script src="js/jquery-2.0.3.min.js"></script>
    
    <script src="js/jquery.floatThead.js"></script>
    <script src="js/dat.js"></script>

    <script>
        /**
         * jQuery.browser.mobile (http://detectmobilebrowser.com/)
         *
         * jQuery.browser.mobile will be true if the browser is a mobile device
         *
         **/
        (function (a) {
            (jQuery.browser = jQuery.browser || {}).mobile = /(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))
        })(navigator.userAgent || navigator.vendor || window.opera); //setting up the search box

        if (jQuery.browser.mobile) {
            window.open('executable.io/blog', '_parent');
        } else {
            customInterface();
        }

        function customInterface() {
            function remap(value, low1, high1, low2, high2) {
                return low2 + (high2 - low2) * (value - low1) / (high1 - low1);
            }

            // Compute the edit distance between the two given strings
            //this is for the search box
            function lDistance(a, b) {
                var al = (a.toLowerCase())
                var bl = (b.toLowerCase())

                if (bl.indexOf(al) > -1) {
                    return true;
                } else {
                    return false;
                }
            };
            var barHeight = .5;
            var fs = 14;
            var immg = 10;
            var reversalSort = 0;
            var w;
            var legend;
            var activeSort = "date0";
            var activeCat = "flatten";
            var catSet;
            var jumper = 20;
            var collapser = "void";
            var sorter = "date";
            var lapser;
            var ter;
            var ker;
            var dur = 800;
            var imAsp = 60 / 400; //(height/width)

            //        var load//consolee = function () {
            //            this.message = 'dat.gui';
            //            this.speed = 0.8;
            //            this.flattened = true;
            //            this.categorize = 'software'
            //            this.sort = 'date'
            //                //  this.explode = function() { ... };
            //                // Define render logic ...
            //        };

            //        window.onload = function () {
            //        var main//consolee = new load//consolee();
            //        var gui = new dat.GUI();
            //        ker = gui.add(main//consolee, 'flattened', true).listen();
            //        lapser = gui.add(main//consolee, 'categorize', ['software', 'topic', 'author']);
            //        ter = gui.add(main//consolee, 'sort', ['date', 'words', 'popularity']);
            //        };



            var blurbGroup = d3.select(".header").append("g")
                //       var logo=d3.select("body").append("svg:image")
            var logo = blurbGroup.selectAll("img").data([0])


            ;
            logo.enter().append("img").attr("src", "images/MODELAB_Logo-Transparent.png").attr("width", "90px").style("position","absolute")
                .on("mouseover", function (d, i) {
                    d3.select("body").style("cursor", "pointer");

                })
                .on("mouseout", function (d, i) {
                    d3.select("body").style("cursor", "default");
                })
                .on("click", function (d, i) {

                    window.open('http://modelab.is', '_blank');
                })






            ;
            var teaser = "A repository of apps, scripts, hacks, builds, and other nonsense."

//            var midBlurb1 = blurbGroup.append("body").html("</br></br>")
            var blurbTitle = blurbGroup.append('body').style("position","absolute") .style("margin-top","30px").style("margin-left","8%").html('<a href="http://executable.io" class="blurbTitle">Mode Lab</a><a href="http://executable.io" class="secondTitle"> Experiments</a>')
            var midBlurb2 = blurbTitle.append("body").html("</br>")
            var blurb = blurbTitle.append('text').attr("class", "blurb").text(teaser)           
            var midBlurb4 = blurbGroup.append("body").html("</br>")
            var filterText = blurbGroup.append('body').attr("text-align","right").attr("class", "catsort").html('<font class="bars">Filter - </font><font id="catAuthor">Author</font> <font class="bars">  |  </font><font id="catTopic">Topic</font><font class="bars">  |  </font><font id="catSoftware">Software</font><font class="bars">  |  </font><font id="catFlatten">Flatten</font><font id="addCol" class="colSet"> [+]</font><font class="colSet" id="subCol"> [-]</font>')
            var midBlurb5 = blurbGroup.append("body").html("</br>")
            var sortText = blurbGroup.append('body').attr("class", "catsort").html('<font class="bars">Sort - </font>  <font id="sortDate">Date (new)</font><font class="bars">  |  </font><font id="sortDateRev">Date (old)</font><font class="bars">  |  </font><font id="sortShuffle">Shuffle</font>')
           var midBlurb3 = blurbGroup.append("body").html("</br>")
            var searchBar = blurbGroup.append("body").attr("class", "sb").html('<input type="text" size="20" id="searchBox" style="text-align:center;" placeholder="search...">')
            //                                var midBlurb6 = blurbGroup.append("body").html("</br>")
                //        var colSetter = blurbGroup.append('body').attr("class", "colSet").html('<font class="bars" id="colCount-">Column </font><font id="addCol" class="colSet">[+]</font><font class="colSet" id="subCol"> [-]</font>')
                //                    var midBlurb6 = blurbGroup.append("body").html("</br>")
                //        midBlurb4=blurbGroup.append("body").html("</br>")
            var color = ["#626366", "#318eb5"];
            var scatterDotSize = 4;
            var oneD = true;
            var del = 40;
            //        var divider = window.innerWidth * .7;
            var margin = {
                    top: 150,
                    right: 0,
                    bottom: 30,
                    left: 0
                },
                width = window.innerWidth / 2,
                height = window.innerHeight - margin.top - margin.bottom;
            var yVals, fullList;
            var yVals2D;
            var h = 150;
            var mg = 5;
            var squishObject = {};
            var xScale = d3.scale.linear()
                .domain([0, 100])
                .range([0, width]);

            var yScale = d3.scale.linear()
                .domain([0, 1000])
                .range([height, 0]);

            var color = d3.scale.category10();

            var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient("bottom");

            var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient("left");

            var format = d3.time.format("%Y-%m-%d-%H-%M-%S").parse;


            var headLeft = +(d3.select(".dummyHeader").style("margin-left").replace("px", ""))
                //////consolee.log(headLeft)

            var headWidth = +(d3.select(".dummyHeader").style("width").replace("px", ""))


            var numCol = 2;






            var svgBaseFixed = d3.select(".svgDiv").append("svg")
                .attr("width", headWidth)
                .attr("height", 20)
                //            .attr("position", "absolute")
                .attr("class", "svgContainerFixed")

            var svgFixed = svgBaseFixed.append("g")





            var svgBase = d3.select(".svgDiv").append("svg")
                .attr("width", headWidth)
                .attr("height", height + margin.top + margin.bottom)
                //            .attr("position", "absolute")
                .attr("class", "svgContainer")
            var svg = svgBase.append("g").attr("id", "mainSVG")

            var legW = 95;
            var legH = legW * 2.737727;

            var svgBaseLegend = d3.select(".legend")
                //                .style("margin-left",250)
                .append("svg")
                .attr("width", legW)
                .attr("height", legH)
                //                .attr("class","legSVG")
                .attr("fill", "none")
                //                .attr("transform","translate("+0+","+230+")")
                //        .attr("transform","translate("+500+","+0+")")

            //                        .attr("position", "absolute")
            //            .attr("class", "svgLegendFixed")

            var svgFixedLegend = svgBaseLegend
                //        .append("g")
                //        .attr("margin-left","80%")
                //        .attr("transform","translate("+25+","+0+")")








            d3.json("data/data.json", function (data) {




                var hVals = [];

                var st = [""];
                $("#searchBox").keyup(function (event) {

                    if (event.keyCode == 13) {
                        handleClick();
                    }
                });
                d3.select("#searchBox").on("blur", function () {
                    //                $("#btnSearch").click();
                    handleClick();
                })

                function handleClick() {
                    st = (document.getElementById("searchBox").value).split(" ");
                    //                ////consolee.log(st)
                    //                ////consolee.log(st);
                    searchSquish();

                    //                winBlock(blocks);
                }

                function rerun() {
                    if (oneD) {
                        sortAll();
                    } else {
                        //                    var xScale = d3.scale.ordinal()
                        //                    .rangeRoundBands([0, headWidth], 1, 1);
                        //                xScale
                        //                    .domain(data.map(function (d) {
                        //                        return d[collapser];
                        //                    }));
                        //                w=headWidth/xScale.domain().length - 10
                        //                 h=w*imAsp;
                        collapse(blocks, 0, h + immg, 0)
                        collapse(blockImages, immg / 2, h, 1)
                        collapse(blockLine, 0, barHeight, 1)
                    }
                }

                function searchSquish() {
                    //                ////consolee.log('swihj')
                    squish(blocks)
                    squish(blockImages)
                    squish(blockLinks)
                    squish(blockLine)
                    squish(blockText)
                    rerun();

                    function squish(theBlock) {

                        theBlock
                            .each(function (d, i) {
                                ob = d3.select(this)
                                    //define string and add meta tags later on
                                checkString = d.author + " " + d.Title + " " + d.topic + " " + d.software + " " + d.text;
                                //test to see if every string in the search bar matches the block in question
                                var searchCount = 0;
                                for (var j = 0; j < st.length; j++) {
                                    if (lDistance(st[j], checkString)) {
                                        searchCount++;
                                    }
                                }

                                if (searchCount == st.length) {
                                    ob.attr("activated", 1)
                                } else {
                                    ob.attr("activated", 0)
                                }
                            })
                    }

                    function squishSimple(theBlock) {
                        theBlock
                            .each(function (d, i) {
                                d3.select(this).attr("activated", function () {
                                        return d3.select("#bR" + i).attr("activated");
                                    })
                                    //                        d3.select(this).attr("activated",function(){return 0;})
                            })
                    }
                }







                d3.selectAll(".bars").attr("color", "gray ")

                //            d3.xml("svg/sort.svg", "image/svg+xml", function (xml) {
                //                var importedNode = document.importNode(xml.documentElement, true);
                //                var svgLegend = svgFixedLegend.node().appendChild(importedNode)
                hoverSort("#sortDate", "date", 0);
                hoverSort("#sortDateRev", "date", 1);
                hoverSort("#sortShuffle", "shuffle", 2);
                //                hoverSort("#sortWords", "words");
                //                hoverSort("#sortHits", "popularity");
                hoverCat("#catAuthor", "author");
                hoverCat("#catTopic", "topic");
                hoverCat("#catFlatten", "flatten");
                hoverCat("#catSoftware", "software");

                sortColor("#sortDate", "date0");
                catColor("#catFlatten", "flatten");

                //            });
                d3.selectAll("#colCount").text("| " + numCol + " |")
                colSet("#addCol",3);
                colSet("#subCol", 1);

                //            colSet("#col3", 3);
                //            colSet("#col4", 4);
                //            colSet("#col5", 5);

                function colSet(selection, value) {

                    if (value == numCol) {
                        d3.select(selection)
                            .attr("color", "#333333")
                    } else {
                        d3.select(selection)
                            .attr("color", "gray")
                    }

                    //consolee.log(value);
                    d3.selectAll(selection)
                        .on("mouseover", function () {
                            if (oneD==true) {
                                if (value != numCol) {
                                    d3.select(this)
                                        .attr("color", "white")
                                }

                                ////consolee.log(d3.select(this).attr("opacity"));
                                //                    if(){
                                //                d3.select("body").style("cursor", "pointer");
                                //            }
                                if (d3.select(this).attr("color") != "#333333") {
                                    d3.select("body").style("cursor", "pointer");
                                }
                            }
                        })
                        .on("mouseout", function () {
                            if (oneD==true) {
                                if (value != numCol) {
                                    d3.select(this)
                                        .attr("color", "gray")
                                } else {
                                    d3.select(this)
                                        .attr("color", "#333333")
                                }
                                d3.select("body").style("cursor", "default");
                            }
                        })
                        .on("click", function () {
                            if (oneD==true) {
                                numCol = value;
//                                mE = remap(numCol, 1, Math.min(8, Math.max(numCol, 8)), 8, 4);
                                //consolee.log(mE);
                                d3.selectAll("#colCount").text("| " + numCol + " |")
                                sortAll();
                                colSet("#addCol", numCol + 1);
                                colSet("#subCol", Math.max(1, numCol - 1));
                            }

                        })
                        //            }
                        //                colColor(selection, value)
                }

                function colColor(selection, value) {
                    if (numCol == value) {
                        d3.selectAll(selection).attr("color", "white")
                    } else {
                        d3.selectAll(selection).attr("color", "gray")
                    }
                }


                function hoverCat(selection, value, rev) {
                    ////consolee.log(d3.select(selection))
                    //////consolee.log('log')

                    catColor(selection, value)

                    d3.selectAll(selection)

                    //                    .selectAll("g")
                    .on("mouseover", function () {
                            ////consolee.log('over')
                            d3.select(this)
                                .attr("color", "white")
                            d3.select("body").style("cursor", "pointer");
                        })
                        .on("mouseout", function () {
                            catColor(selection, value)
                            d3.select("body").style("cursor", "default");
                        })
                        .on("click", function () {

                            if (value == "flatten") {

                                d3.selectAll("#addCol").attr("color", "gray");
                                if (numCol > 1) {
                                    d3.selectAll("#subCol").attr("color", "gray");
                                }
//                                console.log(d3.selectAll("#addCol").attr("color"));
                                activeCat = value;
                                blockText.transition().duration(dur * 4).attr("opacity", 1).attr("display", "inline").attr("font-size", remap(numCol, 1, Math.min(8, Math.max(numCol, 8)), fs, 8))
                                d3.selectAll(".colSet").transition().duration(1200).style("opacity", 1)
                                d3.selectAll(".legendText").remove();
                                oneD = true;
                                sortAll();
                                //                            fullList=[]
                                //                            d3.selectAll("blockImage").each(function(d,i){
                                //                                fullList.push("flattened");
                                //                            })
                                //                            var bim = d3.selectAll("#bR" + i).remove();
                                //                    d3.select("#bC" + i).append(function () {
                                //                        return bim.node();
                                //                    })

                            } else {
                                blockText.transition().duration(dur).attr("opacity", 0).transition().duration(1).attr("display", "none").attr("font-size", 0)
                                d3.selectAll("#addCol").transition().duration(dur).attr("color", "gray");
                                d3.selectAll("#subCol").transition().duration(dur).attr("color", "gray");


                                width = window.innerWidth / 2
                                xScale = d3.scale.linear()
                                    .domain([0, 100])
                                    .range([0, width]);

                                headWidth = +(d3.select(".dummyHeader").style("width").replace("px", ""))
                                oneD = false;
                                collapser = value;
                                collapseBlocks();
                            }

                            activeCat = value;
                            catColor("#catSoftware", "software");
                            catColor("#catAuthor", "author");
                            catColor("#catTopic", "topic");
                            catColor("#catFlatten", "flatten");
                        })

                }

                function catColor(selection, value) {
                    //////consolee.log(value)

                    if (activeCat != value) {
                        //                    ////consolee.log(value);
                        d3.select(selection)
                            .attr("color", "gray")
                    } else {
                        d3.select(selection)
                            .attr("color", "white")
                    }
                }









                function hoverSort(selection, value, rev) {
                    if (value == "date") {
                        sortColor(selection, value + rev)
                    } else {
                        sortColor(selection, value)
                    }
                    d3.selectAll(selection)
                        //                    .selectAll("g")
                        .on("mouseover", function () {
                            d3.select(this)
                                .attr("color", "white")
                            d3.select("body").style("cursor", "pointer");
                        })
                        .on("mouseout", function () {
                            if (value == "date") {
                                sortColor(selection, value + rev)
                            } else {
                                sortColor(selection, value)
                            }
                            d3.select("body").style("cursor", "default");

                        })
                        .on("click", function () {
                            sorter = value;

                            reversalSort = rev;
                            sortAll();
                            if (value == "date") {
                                activeSort = value + rev;
                            } else {
                                activeSort = value;
                            }
                            sortColor("#sortDate", "date0");
                            sortColor("#sortDateRev", "date1");
                            sortColor("#sortShuffle", "shuffle");
                            //                        sortColor("#sortWords", "words");
                            //                        sortColor("#sortHits", "popularity");
                        })
                        //                searchSquish();
                }

                function sortColor(selection, value) {
                    //                //consolee.log(value, activeSort)
                    //                ////consolee.log(activeSort,value)
                    if (activeSort != value) {
                        d3.selectAll(selection)
                            .attr("color", "gray ")
                    } else {
                        d3.selectAll(selection)
                            .attr("color", "white")
                    }
                }









                del = 0 * (1 / data.length);
                //            lapser.onFinishChange(function (value) {
                //                //                twoD=true;
                //                ker.setValue(false)
                //                    //                //////consolee.log(catSet.length)
                //                collapser = value;
                //                collapseBlocks();
                //            })
                //            ter.onFinishChange(function (value) {
                //                //                twoD=false;
                //                sorter = value;
                //                sortAll();
                //            })
                //            ker.onFinishChange(function (value) {
                //                //////consolee.log(value);
                //                d3.selectAll(".legendText").remove();
                //
                //                //                twoD=false;
                //                oneD = value;
                //                sortAll();
                //                //                sortAll();
                //            })

                data.forEach(function (d, i) {
                    d.popularity = +d.popularity;
                    d.words = +d.words;
                    d.date = format(d.date);
                })

                function sortByAscending(a, b) {
                    //                //////consolee.log(a[sorter])
                    return b[sorter] - a[sorter];
                }

                function sortByDescending(a, b) {
                    //                //////consolee.log(a[sorter])
                    return a[sorter] - b[sorter];
                }

                function sortByShuffle(a, b) {
                    return Math.random();
                }

                function sortByWordsAscending(a, b) {
                    return b.words - a.words;
                }

                function sortByPopularityAscending(a, b) {
                    return a.popularity - b.popularity;
                }

                data = data.sort(sortByAscending)
                    //            //////consolee.log(data);

                //////consolee.log(headWidth);




                //            var blocks,blockLine,blockImages;

                var mE = 8;
                var extraMargin = 30;
                fullList = [];
                yVals = [];

                svg.append('filter')
                    .attr('id', 'desaturate')
                    .append('feColorMatrix')
                    .attr('type', 'matrix')
                    .attr('values',"0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0.5 0 1 0");
                
                data.forEach(function (d, i) {

                    //                window["BG" + i] = svg.append("g")

                    var bLink = svg
                        .append("svg:a")
                        .attr("xlink:href", d.url)
                        .attr("target", "_parent")
                        .attr("id", "bL" + i)
                        //                    .append("svg:a")
                        .attr("class", "blockLink")
                        .attr("activated", 1)

                    //               .on("click", function (d, i) {
                    //                                   
                    //                                    window.open(d.url,'_top');
                    //                                    //                    if (twoD) {
                    //                                    //                        sortAll();
                    //                                    //                        twoD = false;
                    //                                    //                    }
                    //                                })

                   
                    var bClip = bLink.append("svg:defs").append("svg:clipPath")
                        .attr("id", "bC" + i)
                    var bRect = bClip.append("rect")
                        .attr("class", "block")
                        .attr("id", "bR" + i)
                        .attr("x", function () {
                            return ((i % numCol) * headWidth / numCol);
                        })
                        .attr("y", function () {
                            yVals.push(i * h)
                            fullList.push("flattened");
                            return extraMargin + Math.floor(i / numCol) * (h + mE * immg) + jumper;
                        })
                        .attr("width", function () {
                            w = headWidth / numCol - immg;
                            return w;
                        })
                        .attr("stroke", "gray")
                        .attr("stroke-width", 1)
                        .attr("opacity", 0)
                        .attr("fill", "none")
                        .attr("height", function(){
                            h = w * imAsp;
//                            console.log(h+immg)
                           return h + immg;})
                        .attr("tempH", h + immg)
                        .attr("activated", 1)

                    bLink
                        .append("svg:image")
                        .style("filter", function (d, i) {
                            if (i % 2 == 0) {
                                return ("filter", "url(#desaturate)");
                            } else {
                                return "";
                            }
                        })
                        .on("mouseover",function(){
                        d3.select(this).style("filter","")
                    })
                    .on("mouseout",function(){
                        d3.select(this).style("filter","url(#desaturate)")
                    })
                        .attr("opacity", 1)
                        .attr("class", "blockImage")
                        .attr("id", "bI" + i)
                        .attr("xlink:href", d.img)
                        .attr("width", function () {

                            h = w * imAsp;
                            return w;
                        })
                        .style("clip-path", "url(#bC" + i + ")")

                    .attr("height", h)
                        .attr("tempH", h)
                        .attr("x", function () {
                            return (i % numCol) * headWidth / numCol;
                        })
                        //                .attr("stroke","white")
                        .attr("y", extraMargin + Math.floor(i / numCol) * (h + mE * immg) + jumper)
                        .attr("activated", 1)
                        .attr("transform", "translate(" + 0 + "," + 0 + ")")




                    bLink.append("rect")
                        .attr("id", "bD" + i)
                        .attr("opacity", 1)
                        .attr("class", "blockLine")
                        .attr("width", w)
                        .attr("height", barHeight)
                        .attr("tempH", barHeight)
                        .attr("x", function () {
                            return (i % numCol) * headWidth / numCol;
                        })
                        .attr("y", extraMargin + Math.floor(i / numCol) * (h + mE * immg) + jumper)
                        .attr("fill", "gray")
                        .attr("activated", 1)
                    bLink.append("text").text(d.Title)
                        .attr("x", function () {
                            return (i % numCol) * headWidth / numCol + w / 2 + immg / 2;
                        })

                    .attr("y", function () {
                            return extraMargin + Math.floor(i / numCol) * (h + mE * immg) + jumper - immg;
                        })
                        .attr("id", "bT" + i)
                        .attr("activated", 1)
                        .attr("class", "bText")
                        .attr('fill', 'gray')
                        .attr("opacity", 1)
                        .attr("text-anchor", "middle")
                        .attr('font-size', fs)
                        //                //////consolee.log(d3.select(svg).node().getBBox());

                    
                })


                updateSVGHeight()
                var blockText = d3.selectAll(".bText").data(data)
                var blocks = d3.selectAll(".block").data(data)
                var blockLine = d3.selectAll(".blockLine").data(data)
                var blockImages = d3.selectAll(".blockImage").data(data)
                var blockLinks = d3.selectAll(".blockLink").data(data)
                    .on("mouseover", function (d, i) {
                        d3.select("#bR" + i).attr("opacity", 1)

                        ;
                        //                 d3.select(this)
                        //////consolee.log(d[sorter]);
                        //////consolee.log(d[collapser])
//                        console.log(d.Title)
                        var splitTitle=d.Title.split(" ");
                        var remainingTitle=(splitTitle.splice(1,splitTitle.length-1).join(" "))
//                        console.log(remainingTitle)
                        blurbTitle.html('<span class="blurbTitle">'+splitTitle[0]+'</span><span class="secondTitle"> '+remainingTitle+'</span>')
                        midBlurb2 = blurbTitle.append("body").html("</br>")
                        blurb = blurbTitle.append('text').attr("class", "blurb").text(d.text)
//                        blurbTitle.text(d.Title)
                        d3.select("body").style("cursor", "pointer");
                        //                    if (twoD == false) {
                        //                        collapseBlocks();
                        //                        twoD = true;
                        //                    }
                    })
                    .on("mouseout", function (d, i) {
                        d3.select("#bR" + i).attr("opacity", 0);
                        d3.select("body").style("cursor", "default");

                        blurbTitle.html('<a href="http://executable.io" class="blurbTitle">Mode Lab</a><a href="http://executable.io" class="secondTitle"> Experiments</a>')
                        midBlurb2 = blurbTitle.append("body").html("</br>")
                        blurb = blurbTitle.append('text').attr("class", "blurb").text(teaser)
//                        blurb.text(teaser)
                    })
                    .on("click", function (d, i) {

                        //                                    window.open(d.url,'_top');
                        //                    if (twoD) {
                        //                        sortAll();
                        //                        twoD = false;
                        //                    }
                    })
//                numCol=3;
//                var tempDur=dur;
//                dur=800;
//                sortAll();
//                dur=800;
                function getAcVal(ob) {
                    var val = +d3.select(ob).attr("activated");
                    if (val == 1) {
                        return 0;
                    } else {
                        return 1;
                    }
                    //                    return val;
                }


                function sortAll() {
          
                    if (reversalSort == 0) {
                        blockText
                            .sort(sortByAscending)
                        blockLinks
                            .sort(sortByAscending)
                        blockImages
                            .sort(sortByAscending)
                        blocks
                            .sort(sortByAscending)
                        blockLine
                            .sort(sortByAscending)
                    } else if (reversalSort == 1) {
                        blockText
                            .sort(sortByDescending)
                        blockLinks
                            .sort(sortByDescending)
                        blockImages
                            .sort(sortByDescending)
                        blocks
                            .sort(sortByDescending)
                        blockLine
                            .sort(sortByDescending)
                    } else if (reversalSort == 2) {
                        console.log('asdf')
                        blockText
                            .sort(sortByShuffle)
                        blockLinks
                            .sort(sortByShuffle)
                        blockImages
                            .sort(sortByShuffle)
                        blocks
                            .sort(sortByShuffle)
                        blockLine
                            .sort(sortByShuffle)
                    }




                    headWidth = +(d3.select(".dummyHeader").style("width").replace("px", ""))
                        //consolee.log(activeCat);
                    if (activeCat == "flatten") {
                        w = headWidth / numCol - immg
                    } else {
                        xScale = d3.scale.ordinal()
                            .rangeRoundBands([0, headWidth], 1, 1);
                        xScale
                            .domain(data.map(function (d) {
                                return d[collapser];
                            }));
                        w = headWidth / xScale.domain().length - immg
                            //consolee.log(xScale.domain().length);
                    }

                    //h = w * imAsp;
                    //consolee.log(activeCat);
                    sorts0(blocks, 0, h + immg, 0);
                    sorts0(blockImages, 0, h, 1);
                    sorts0(blockLine, 0, barHeight, 1);
                    sortText(blockText, 0, h + immg, .8);

                    //this is really trippy but it needs to be done
                    blockImages.each(function (d, i) {
                            var bim = d3.select("#bR" + i).remove();
                            d3.select("#bC" + i).append(function () {
                                return bim.node();
                            })



                            var bim = d3.select("#bT" + i).remove();
                            d3.select("#bL" + i).append(function () {
                                return bim.node();
                            })

                            var bim = d3.select("#bI" + i).remove();
                            d3.select("#bL" + i).append(function () {
                                return bim.node();
                            })
                            var br = d3.select("#bR" + i).remove();
                            d3.select("#bC" + i).append(function () {
                                return br.node();
                            })
                            var bd = d3.select("#bD" + i).remove();
                            d3.select("#bL" + i).append(function () {
                                return bd.node();
                            })
                        })
                        //consolee.log('sorted')
                    function sortText(theBlock, pop, hHit, tHit) {
                        if (oneD == true) {
                            var subtractor = 0;
                            theBlock
                                .attr("display", function () {
                                    return "inline";
                                })
                            theBlock
                                .transition()
                                .duration(dur)

                            .attr("opacity", function () {
                                    //                            //consolee.log(getAcVal(this))
                                    if (getAcVal(this) == 0) {
                                        return tHit;
                                    }
                                    if (getAcVal(this) == 1) {
                                        return 0;
                                    }
                                })
                                .attr("y", function (d, i) {
                                    if (i == 0) {
                                        flatSquish = {};
                                    }
                                    if (flatSquish[i % numCol] == undefined) {
                                        flatSquish[i % numCol] = 0;
                                    }
                                    flatSquish[i % numCol] += getAcVal(this);

                                    //                                if (getAcVal(this) == 0) {
                                    //                                   extraMargin+Math.floor(i / numCol) * (h+mE*immg) + jumper-immg;
                                    var yval = extraMargin + (Math.floor(i / numCol) - (flatSquish[i % numCol])) * (h + mE * immg) + jumper - immg;
                                    //                            //consolee.log(yval)
                                    return yval;
                                    //                                } 
                                    //                            else {
                                    //                                    return d3.select(this).attr("y");
                                    //                                }
                                })
                                .transition()
                                .duration(dur)

                            .attr("x", function (d, i) {
                                    return (i % numCol) * headWidth / numCol + w / 2 + immg / 2;
                                })
                                .attr("font-size", function () {
                                    if (getAcVal(this) == 0) {
                                        return remap(numCol, 1, Math.min(8, Math.max(numCol, 8)), fs, 8);
                                    } else {
                                        return 0;
                                    }

                                })


                        }
                        //                   //consolee.log('test')
                    }

                    function sorts0(theBlock, pop, hHit, tHit) {
                        //                    ////consolee.log("")
                        squishObject = {}
                        var flatSquish = {};
                        if (oneD == true) {
                            var subtractor = 0;
                            theBlock
                                .transition()
                                .duration(dur)


                            .attr("opacity", function () {
                                    if (getAcVal(this) == 0) {
                                        ////consolee.log(tHit);
                                        return tHit;
                                    } else {
                                        return 0;
                                    }
                                })
                                .attr("y", function (d, i) {
                                    if (i == 0) {
                                        flatSquish = {};
                                    }
                                    if (flatSquish[i % numCol] == undefined) {
                                        flatSquish[i % numCol] = 0;
                                    }
                                    flatSquish[i % numCol] += getAcVal(this);

                                    if (getAcVal(this) == 0) {
                                        return extraMargin + (Math.floor(i / numCol) - (flatSquish[i % numCol])) * (h + mE * immg) + jumper + pop;
                                    } else {
                                        return d3.select(this).attr("y");
                                    }
                                })
                                .transition()
                                .duration(dur)



                            .attr("x", function (d, i) {
                                    var xval = (i % numCol) * headWidth / numCol;
                                    if (theBlock.attr("class") == "blockImage") {
                                        return xval - theBlock.attr("width") / 2 + w / 2;
                                    } else {
                                        return xval;
                                    }
                                })
                                .attr("height", function () {
                                    if (getAcVal(this) == 0) {
                                        return hHit;
                                    } else {
                                        return 0;
                                    }

                                })
                                //                            .attr("width", w)

                            .attr("width", function (d, i) {
                                if (theBlock.attr("class") == "blockImage") {
                                    return theBlock.attr("width");
                                } else {
                                    return w;
                                }
                            })

                            //                            .attr("width", headWidth)
                            .each("end", updateSVGHeight)
                        } else {

                            w = headWidth / xScale.domain().length - immg
                                //h = w * imAsp;
                            collapse(theBlock, pop, hHit, tHit)

                        }
                    }

                    
//                    colSet("#addCol",3);
                }

                function collapseBlocks() {

                    //                //////consolee.log('collapsed')
                    var xScale = d3.scale.ordinal()
                        .rangeRoundBands([0, headWidth], 1, 1);
                    xScale
                        .domain(data.map(function (d) {
                            return d[collapser];
                        }));
                    catSet = (xScale.domain())
                    var cBlockWidth = ((headWidth) / (xScale.domain().length));

                    d3.selectAll(".legendText").remove();
                    for (var j = 0; j < catSet.length; j++) {
                        legend =
                            svgFixed
                            .append("text")
                            .attr("class", "legendText")
                            .attr("opacity", 0)

                        .text(catSet[j])
                            .attr("x", function () {
                                //consolee.log(j)
                                return (cBlockWidth) * j + cBlockWidth / 2;
                            })
                            //                        .attr("x", function (d, i) {
                            //                            return xScale(j) * (catSet.length + 1) / (catSet.length) - cBlockWidth + mg;
                            //                        })
                            .attr("y", 12)
                            //                    .attr("position","absolute")
                            //                        .attr("font-family", "sans-serif")
                            .attr("font-size", "14px")
                            .attr("fill", "gray")
                            .attr("text-align", "center")
                            .attr("text-anchor", "middle")
                        legend.transition().duration(dur * 2).attr("opacity", 1)
                    }

                    w = headWidth / xScale.domain().length - immg
                        //h = w * imAsp;
                    collapse(blocks, 0, h + immg, 0)
                    collapse(blockImages, 0, h, 1)
                    collapse(blockLine, 0, barHeight, 1)
                }

                //            function sorts(theBlock, pop) {
                //                collapse(theBlock, pop)
                //            }

                function collapse(theBlock, pop, hite, tHit) {
                    //consolee.log(w)
                    var xScale = d3.scale.ordinal()
                        .rangeRoundBands([0, headWidth], 1, 1);
                    xScale
                        .domain(data.map(function (d) {
                            return d[collapser];
                        }));

                    var cBlockWidth = ((headWidth) / (xScale.domain().length));

                    fullList = []
                    yVals = []
                    theBlock
                        .each(function (d, i) {
                            //                    if(getAcVal(this)==0){
                            fullList.push(d[collapser]);
                            //                    }
                            var counter = 0;

                            for (var j = 0; j < fullList.length; j++) {
                                if (fullList[j] == d[collapser]) {
                                    //                                ////consolee.log(getAcVal(this))
                                    //                                counter+=Math.abs(getAcVal(this)-1)
                                    counter++
                                }
                                if (j == fullList.length - 1) {
                                    yVal = (counter - 1) * (h + immg) + pop +29
                                        //                                ////consolee.log(counter)
                                    yVals.push(yVal);
                                }
                            }
                        })
                        .call(dropBlocks, yVals, pop, hite);

                    function dropBlocks(theBlock, yVals, pop) {
                        var blockHeight = h + pop;
                        squishObject = {};
                        for (var j = 0; j < fullList.length; j++) {
                            squishObject[fullList[j]] = 0;
                        }

                        //                    theBlock
                        //                        .each(function (d, i) {
                        //                            if(getAcVal(this)==1){
                        //                                squishObject[d[collapser]] += 1;
                        //                            }
                        //                        })

                        ////consolee.log(yVals);

                        var mapCount = d3.set(fullList).values().length
                            //                        //////consolee.log(mapCount)
                        theBlock
                            .transition()
                            .duration(dur)
                            .attr("x", function (d, i) {
                                var xval = xScale(d[collapser]) * (mapCount + 1) / (mapCount) - cBlockWidth;
                                if (theBlock.attr("class") == "blockImage") {
                                    return xval - theBlock.attr("width") / 2 + (cBlockWidth - mg * 2) / 2;
                                } else {
                                    return xval;
                                }

                            })
                            .attr("width", function (d, i) {
                                if (theBlock.attr("class") == "blockImage") {
                                    return theBlock.attr("width");
                                } else {
                                    return cBlockWidth - mg * 2;
                                }
                            })
                            .transition()
                            .attr("opacity", function () {
                                if (getAcVal(this) == 1) {
                                    return 0;
                                } else {
                                    return tHit;
                                }
                                //                            return Math.abs(getAcVal(this) - 1)
                            })
                            .attr("height", function (d, i) {
                                if (getAcVal(this) == 1) {
                                    return 0;
                                } else {
                                    return hite;
                                }
                            })
                            .attr("y", function (d, i) {
                                if (getAcVal(this) == 1) {
                                    squishObject[d[collapser]] += 1;
                                    return yVals[i] + 20;
                                } else {
                                    return (yVals[i] - ((h + immg) * (squishObject[d[collapser]]) - 1)) + 20;
                                }
                            })
                            .each("end", updateSVGHeight)

                    }

                }

                function updateSVGHeight() {
                    var subber = +(svgBase.style("margin-top").replace("px", ""))
                    var resizeHeight = Math.max((d3.select("#mainSVG").node().getBoundingClientRect().height), window.innerHeight - subber - 55)
                    svgBase.transition().duration(dur / 4).attr("height", resizeHeight + 50)
                    
                }


                window.addEventListener('resize', onWindowResize, false);

                function onWindowResize() {
                    width = window.innerWidth / 2
                    xScale = d3.scale.linear()
                        .domain([0, 100])
                        .range([0, width]);

                    var headWidth = +(d3.select(".dummyHeader").style("width").replace("px", ""))
                    var headerHeight=+(d3.select(".header").style("height").replace("px", ""))
//                    d3.selectAll(".secondTitle").attr("font-size",headerHeight/4+" px")
//                    d3.selectAll(".blurbTitle").style("font-size",headerHeight/4)
//                    console.log(d3.selectAll(".secondTitle").attr("font-size"))
//                    console.log(headerHeight);
                    svgBaseFixed
                        .attr("width", headWidth)
                        .attr("height", 20)
                        //            .attr("position", "absolute")
                        //                    .attr("class", "svgContainerFixed")

                    svgBase
                        .attr("width", headWidth)
                        .attr("height", height + margin.top + margin.bottom)
                        .attr("class", "svgContainer")


                    data.forEach(function (d, i) {

                            //                window["BG" + i] = svg.append("g")

                            d3.select("#bI" + i)

                            .attr("width", headWidth)
                            d3.select("#bR" + i)

                            .attr("width", headWidth)
                            d3.select("#bD" + i)

                            .attr("width", headWidth)




                        })
                    
                        //                 dur=0;
                    dur=400;
                    if (oneD == true) {
                        sortAll()
                    } else {
                        winBlock(blocks, 0);
                        winBlock(blockImages, 5);
                        winBlock(blockLine, 0);
                    }

                    function winBlock(theBlock, pop) {
                        xScale = d3.scale.ordinal()
                            .rangeRoundBands([0, headWidth], 1, 1);
                        xScale
                            .domain(data.map(function (d) {
                                return d[collapser];
                            }));
                        cBlockWidth = ((headWidth) / (xScale.domain().length));
                        mapCount = d3.set(fullList).values().length
                            //                        //////consolee.log(mapCount)
                        theBlock
                            .attr("x", function (d, i) {

                                //                                //////consolee.log(catSet)
                                return xScale(d[collapser]) * (mapCount + 1) / (mapCount) - cBlockWidth;
                            })
                            .attr("width", cBlockWidth - mg * 2)

                        d3.selectAll(".legendText").remove();
                        for (var j = 0; j < catSet.length; j++) {
                            //                    //////consolee.log(j)
                            //                    var div=svg.append("div")
                            legend =
                                //                        d3.selectAll(".categories").append("g")
                                svgFixed
                                .append("text")
                                .attr("class", "legendText")
                                .attr("opacity", 0)

                            .text(catSet[j])
                                //                    .attr("transform", "translate(" + (cBlockWidth) * (j + 1) + "," + 10 + ")")
                                .attr("x", (cBlockWidth) * (j) + cBlockWidth / 2)
                                .attr("y", 10)
                                //                    .attr("position","absolute")
                                //                            .attr("font-family", "sans-serif")
                                .attr("font-size", "14px")
                                .attr("fill", "gray")
                                .attr("text-align", "center")
                                .attr("text-anchor", "middle")
                            legend.attr("opacity", 1)
                        }
                    }
                    dur=800;

                }





            })
        }
    </script>

    </script>
</body>